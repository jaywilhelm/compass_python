from client import create_gateway_client, get_enum_str
from tinydb_viewer import TinyDB

import grpc
import compassiot.gateway.v1.gateway_pb2_grpc as gateway
import compassiot.compass.v1.time_pb2 as time
import compassiot.platform.v1.streaming_pb2 as streaming

def main():
    TinyDB('i77SB_D4_July2025.json').runserver()

    client = create_gateway_client()

    request = streaming.TrajectoryByPathRequest(
        #random 33 SE Ohio segment
        #linestring_wkt=    "LINESTRING(-82.65659331 39.68409211,-82.65479544 39.68190399,-82.65248728 39.67978823,-82.65058112 39.67869679,-82.64776913 39.67755011,-82.64486680 39.67632107,-82.64115453 39.67474288,-82.63825640 39.67363797,-82.63454725 39.67281955)",
        
        #D4 SB on i77
        linestring_wkt="LINESTRING( -81.62644088236203 41.217365376598, -81.62643993954205 41.2172715330197, -81.62635949278484 41.21631165336034, -81.62611760330999 41.21392628822691, -81.62607877053922 41.21332623898555, -81.62606063334633 41.21317627897984, -81.62590573474071 41.21076914658153, -81.62588311703017 41.20768120949135, -81.62583553983713 41.204381097386, -81.62582701859287 41.20260573864138, -81.62581643338179 41.19892879859241, -81.62578833384464 41.19583220973179, -81.62580104770451 41.19234779028474, -81.62579875897113 41.18896515398877, -81.62594929191847 41.18244680530047, -81.62605097923901 41.17696432407892, -81.62627982093352 41.16683320859274, -81.62641149096162 41.15899242768791, -81.62646510640866 41.15783522185043, -81.62660071846948 41.15657605115067, -81.62692527260441 41.15548954782477, -81.62700881116879 41.15526276173077, -81.6276077830981 41.15412752772648, -81.62856254266639 41.15294592097285, -81.62965342678589 41.15205171419368, -81.63005426956211 41.15178322023792, -81.63359967201876 41.14975619992858, -81.6358861390601 41.14805054701019, -81.64362423096702 41.14349424190394, -81.64638468241996 41.14198907467895, -81.64826303670341 41.14079891948978, -81.64947891170317 41.1395418104248, -81.65025454204962 41.13795504663672, -81.65077553633195 41.13599931100581, -81.65160448884866 41.13237972635758, -81.6526613462093 41.12780234694011)"
        #"LINESTRING (151.188277 -33.884699, 151.18862 -33.884707, 151.189805 -33.884734, 151.190091 -33.884743, 151.19063 -33.884758, 151.190909 -33.884747, 151.191247 -33.884724, 151.191281 -33.884723, 151.191439 -33.88471, 151.191552 -33.884699, 151.191722 -33.884682, 151.192145 -33.884643, 151.192449 -33.884608)",
        date_time_range= time.DateTimeRange(
            start=time.LocalDate(
                day=1,
                month=7,
                year=2025
            ),
            end=time.LocalDate(
                day=31,
                month=1,
                year=2025
            ),
            # day_of_week=[
            #     time.DayOfWeek.SATURDAY,
            #     time.DayOfWeek.SUNDAY
            # ],
            hour_of_day=[i for i in range(24)], # 0 to 23
            # include the list of dates you would like to exclude from the query, if any
            # exclude_date=[
            #     time.LocalDate(
            #         day=10,
            #         month=10,
            #         year=2023
            #     ),
            #     time.LocalDate(
            #         day=11,
            #         month=10,
            #         year=2023
            #     ),
            # ]
        )

    )

    for response in client.TrajectoryByPath(request):
        ## helper to print enum objects
        # print("Vehicle Type:", get_enum_str(response, streaming.ProcessedPoint.VEHICLE_TYPE_FIELD_NUMBER, response.vehicle_type))
        print(response)


if __name__ == "__main__":
    main()
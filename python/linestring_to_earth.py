import re
import xml.etree.ElementTree as ET
from xml.dom import minidom

def parse_wkt_linestring(wkt: str):
    """
    Parse WKT LINESTRING into a list of (lon, lat) floats.

    Expected input format:
      LINESTRING(lon lat, lon lat, ...)
    Example:
      LINESTRING(-81.6259 41.2126, -81.6261 41.2127)
    """
    if not isinstance(wkt, str):
        raise TypeError(f"wkt must be a string, got {type(wkt).__name__}")

    wkt = wkt.strip()

    m = re.search(r"^\s*LINESTRING\s*\((.*)\)\s*$", wkt, re.IGNORECASE | re.DOTALL)
    if not m:
        raise ValueError("Input is not a valid WKT LINESTRING")

    body = m.group(1).strip()
    if not body:
        raise ValueError("LINESTRING has no coordinates")

    points = []
    for idx, part in enumerate(body.split(","), start=1):
        coords = part.strip().split()
        if len(coords) != 2:
            raise ValueError(f"Invalid coordinate pair at position {idx}: '{part}'")

        lon = float(coords[0])
        lat = float(coords[1])

        points.append((lon, lat))

    if len(points) < 2:
        raise ValueError("LINESTRING must contain at least 2 points")

    return points


def linestring_wkt_to_kml(
    wkt_linestring: str,
    output_kml_path: str,
    *,
    name: str = "Route",
    description: str = "",
    altitude_mode: str = "clampToGround",
    tessellate: bool = True
):
    """
    Convert WKT LINESTRING(lon lat, ...) to a Google Earth KML file.
    """
    points = parse_wkt_linestring(wkt_linestring)

    kml_ns = "http://www.opengis.net/kml/2.2"
    ET.register_namespace("", kml_ns)

    kml = ET.Element(f"{{{kml_ns}}}kml")
    doc = ET.SubElement(kml, "Document")

    placemark = ET.SubElement(doc, "Placemark")
    ET.SubElement(placemark, "name").text = name
    if description:
        ET.SubElement(placemark, "description").text = description

    line = ET.SubElement(placemark, "LineString")
    ET.SubElement(line, "tessellate").text = "1" if tessellate else "0"
    ET.SubElement(line, "altitudeMode").text = altitude_mode

    # KML coords are "lon,lat,alt" (alt optional). We'll emit alt=0.
    coords_text = "\n".join(f"{lon},{lat},0" for lon, lat in points)
    ET.SubElement(line, "coordinates").text = coords_text

    # Pretty print XML
    rough = ET.tostring(kml, encoding="utf-8", xml_declaration=True)
    pretty = minidom.parseString(rough).toprettyxml(indent="  ")

    with open(output_kml_path, "w", encoding="utf-8") as f:
        f.write(pretty)
        
def load_linestring_from_textfile(path: str) -> str:
    """
    Load a WKT LINESTRING from a text file and return it as a single string.
    Preserves content but normalizes whitespace.
    """
    with open(path, "r", encoding="utf-8") as f:
        text = f.read()

    if not text.strip():
        raise ValueError(f"{path} is empty")

    return text.strip()      
        
#D4_linestring_or_polygon_wkt="LINESTRING( -81.62599377654583 41.21260408508934, -81.6259393970301 41.211875817912464, -81.62589510739166 41.211210228941496, -81.62587675750535 41.210819283917786, -81.62586631189524 41.21045332891874, -81.62586136307633 41.21003052949735, -81.62584887649386 41.20946114270457, -81.62583799789579 41.208152809078385, -81.62584370668942 41.207456464467995, -81.62582881352033 41.205038847719145, -81.62582886562261 41.20415155451301, -81.62581985731693 41.203496953653875, -81.62581402814907 41.20240835912694, -81.62580643828322 41.2008157080937, -81.62581470817375 41.19927807551641, -81.62580043394385 41.19829985610853, -81.62579760155579 41.19730290750774, -81.62580005305819 41.19638655404537, -81.62579328694747 41.194339180867644, -81.62577826531928 41.19292666190158, -81.62578469186683 41.19231375305959, -81.62578148757622 41.19146675098759, -81.62578323569774 41.190354170443214, -81.62580816035363 41.18900632682608, -81.62584611686933 41.18671207508145, -81.62592091329482 41.18350642031561, -81.62594961626478 41.181833453999374, -81.6259812207931 41.180668609099435, -81.62600637631601 41.17937464210955, -81.62601674916259 41.17835104370191, -81.6260674716368 41.17647472139874, -81.6260698692403 41.17604575434983, -81.62607789029747 41.17560955028153, -81.62612565282281 41.17317873199183, -81.62615068347988 41.17226612778515, -81.62621662521164 41.16904965364146, -81.62624420079591 41.16740079465822, -81.62627161378511 41.166432127790856, -81.6263321090313 41.16354353872006, -81.62636114168296 41.162351544030855, -81.62637020029429 41.16155096947116, -81.62641848743576 41.15985372723147, -81.62644660111089 41.15833671659302, -81.62645536237986 41.15804307658687, -81.62647091221743 41.157721492867374, -81.62649863243045 41.15733293985564, -81.62650875195213 41.15725966310807, -81.62654325354725 41.15701039764644, -81.62660805621522 41.156618425510004, -81.62669179986095 41.15626322593898, -81.6267581467329 41.15600168954793, -81.6268829954894 41.155579822169415, -81.62695341262788 41.15538168296272, -81.62706656262444 41.155110767901746, -81.6272130374231 41.154813452240916, -81.62744405626638 41.15436778634, -81.62758920694831 41.15411789640514, -81.62780288651 41.153817291051205, -81.62802415773415 41.153537442590746, -81.62836813253791 41.15313301358908, -81.62863452524049 41.15286321407547, -81.62889740373365 41.152616611772274, -81.62910284843913 41.15243781802904, -81.62927566094358 41.152296500329015, -81.62952003144696 41.15210952803534, -81.62961293521363 41.152042876882916, -81.62987806578322 41.151852635487636, -81.63023905917005 41.15162501607853, -81.63091800226852 41.1512389499357, -81.63134471640153 41.151009530494186, -81.63157724441452 41.15088442062645, -81.63261629875419 41.15033777196464, -81.63301415181373 41.1501225636748, -81.63335688873902 41.14993386774427, -81.6338120120929 41.14965327351982, -81.63413983788278 41.14942864237369, -81.63447986728582 41.149189967090486, -81.63484300764615 41.148922115034985, -81.63512323979398 41.14869389559991, -81.63596782594264 41.14797388840052, -81.63624468132333 41.1477577936494, -81.6365950287757 41.14747409130412, -81.63675886082228 41.147353310729706, -81.63694505103796 41.147215858808806, -81.6371663860425 41.14705963775819, -81.63735680462821 41.14692530637886, -81.63768032209802 41.14671926639354, -81.63798583373624 41.14653388884035, -81.63839692257318 41.14628590304506, -81.63912780805802 41.14587100093406, -81.63943127782564 41.14571476788532, -81.6399153125586 41.145450740594164, -81.64110039792916 41.14482225878288, -81.64176146904508 41.1444645349434, -81.64271191626007 41.14396009206382)"
lsname="D4_OHGO"
# lsname="D7_OHGO"

wkt_string = load_linestring_from_textfile(lsname+".txt")

if __name__ == "__main__":
    # Example usage:
    #wkt = "LINESTRING(-81.62599377654583 41.21260408508934, -81.62610311451245 41.21271288419942, -81.62620151234567 41.21282000000000)"
    linestring_wkt_to_kml(wkt_string, lsname+".kml", name=lsname, description="Converted from WKT")
    print(lsname+".kml")
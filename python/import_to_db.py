import os
import configparser
import mariadb
from create_vehicle_telemetry_table import *
from csv_import_lib import *
from datetime import datetime

def get_db_connection(config_path="db_config.ini"):
    config = configparser.ConfigParser()
    config.read(config_path)

    db = config["mariadb"]

    return mariadb.connect(
        host=db["host"],
        port=int(db.get("port", 3306)),
        database=db["database"],
        user=db["user"],
        password=db["password"],
        autocommit=False
    )
conn = get_db_connection()

####
#
# print(drop_vehicle_telemetry_table(conn))
# print(drop_metadata_table(conn))
# #
# ####
# print(create_metadata_table(conn))
# status = recreate_table_if_empty(conn, "vehicle_telemetry")
# print(status)

D4_linestring_or_polygon_wkt="LINESTRING( -81.62599377654583 41.21260408508934, -81.6259393970301 41.211875817912464, -81.62589510739166 41.211210228941496, -81.62587675750535 41.210819283917786, -81.62586631189524 41.21045332891874, -81.62586136307633 41.21003052949735, -81.62584887649386 41.20946114270457, -81.62583799789579 41.208152809078385, -81.62584370668942 41.207456464467995, -81.62582881352033 41.205038847719145, -81.62582886562261 41.20415155451301, -81.62581985731693 41.203496953653875, -81.62581402814907 41.20240835912694, -81.62580643828322 41.2008157080937, -81.62581470817375 41.19927807551641, -81.62580043394385 41.19829985610853, -81.62579760155579 41.19730290750774, -81.62580005305819 41.19638655404537, -81.62579328694747 41.194339180867644, -81.62577826531928 41.19292666190158, -81.62578469186683 41.19231375305959, -81.62578148757622 41.19146675098759, -81.62578323569774 41.190354170443214, -81.62580816035363 41.18900632682608, -81.62584611686933 41.18671207508145, -81.62592091329482 41.18350642031561, -81.62594961626478 41.181833453999374, -81.6259812207931 41.180668609099435, -81.62600637631601 41.17937464210955, -81.62601674916259 41.17835104370191, -81.6260674716368 41.17647472139874, -81.6260698692403 41.17604575434983, -81.62607789029747 41.17560955028153, -81.62612565282281 41.17317873199183, -81.62615068347988 41.17226612778515, -81.62621662521164 41.16904965364146, -81.62624420079591 41.16740079465822, -81.62627161378511 41.166432127790856, -81.6263321090313 41.16354353872006, -81.62636114168296 41.162351544030855, -81.62637020029429 41.16155096947116, -81.62641848743576 41.15985372723147, -81.62644660111089 41.15833671659302, -81.62645536237986 41.15804307658687, -81.62647091221743 41.157721492867374, -81.62649863243045 41.15733293985564, -81.62650875195213 41.15725966310807, -81.62654325354725 41.15701039764644, -81.62660805621522 41.156618425510004, -81.62669179986095 41.15626322593898, -81.6267581467329 41.15600168954793, -81.6268829954894 41.155579822169415, -81.62695341262788 41.15538168296272, -81.62706656262444 41.155110767901746, -81.6272130374231 41.154813452240916, -81.62744405626638 41.15436778634, -81.62758920694831 41.15411789640514, -81.62780288651 41.153817291051205, -81.62802415773415 41.153537442590746, -81.62836813253791 41.15313301358908, -81.62863452524049 41.15286321407547, -81.62889740373365 41.152616611772274, -81.62910284843913 41.15243781802904, -81.62927566094358 41.152296500329015, -81.62952003144696 41.15210952803534, -81.62961293521363 41.152042876882916, -81.62987806578322 41.151852635487636, -81.63023905917005 41.15162501607853, -81.63091800226852 41.1512389499357, -81.63134471640153 41.151009530494186, -81.63157724441452 41.15088442062645, -81.63261629875419 41.15033777196464, -81.63301415181373 41.1501225636748, -81.63335688873902 41.14993386774427, -81.6338120120929 41.14965327351982, -81.63413983788278 41.14942864237369, -81.63447986728582 41.149189967090486, -81.63484300764615 41.148922115034985, -81.63512323979398 41.14869389559991, -81.63596782594264 41.14797388840052, -81.63624468132333 41.1477577936494, -81.6365950287757 41.14747409130412, -81.63675886082228 41.147353310729706, -81.63694505103796 41.147215858808806, -81.6371663860425 41.14705963775819, -81.63735680462821 41.14692530637886, -81.63768032209802 41.14671926639354, -81.63798583373624 41.14653388884035, -81.63839692257318 41.14628590304506, -81.63912780805802 41.14587100093406, -81.63943127782564 41.14571476788532, -81.6399153125586 41.145450740594164, -81.64110039792916 41.14482225878288, -81.64176146904508 41.1444645349434, -81.64271191626007 41.14396009206382)",
D7_linestring_or_polygon_wkt="LINESTRING( -84.1898015470108 39.841716477293716, -84.18979969378638 39.84165140355554, -84.18974870361424 39.84030206333315, -84.18969443099803 39.837729528743985, -84.18962116440345 39.834585971794205, -84.18961847844076 39.8344706907382, -84.1896021012548 39.83378638350034, -84.18937046976048 39.824054583235515, -84.18926660924228 39.81977674376397, -84.1891626382313 39.81549377068289, -84.18910326587923 39.8130277316431, -84.18896343232545 39.80721900977772, -84.1889416104506 39.806291410877805, -84.18893327228811 39.805937007536805, -84.18893331810219 39.805847372988154, -84.18893324893192 39.80576746946502, -84.18893417868823 39.80562764549461, -84.18893579565574 39.80556429319604, -84.18893795700232 39.805480033396044, -84.18894240725625 39.805393848785215, -84.18894625563891 39.80532136546049, -84.18895347180559 39.805209556925234, -84.18896065742955 39.8050964880679, -84.18896630423943 39.805011456841115, -84.18897557844642 39.80491709520259, -84.18898585966485 39.80483055654863, -84.18900249107404 39.80470726165574, -84.18901744173529 39.804596512138055, -84.18903402912701 39.80449546892019, -84.1890504143978 39.80440055379006, -84.18906577558914 39.80431159976464, -84.18908329183888 39.80421513713496, -84.18910001038464 39.804138774787454, -84.1891205907878 39.8040483035392, -84.189141914996 39.80395475837241, -84.18916098263622 39.80387412802172, -84.18918590010557 39.80377467585589, -84.18921005310862 39.803687035706695, -84.18923430312971 39.80359858385907, -84.18926154094744 39.80350810637905, -84.18929601379648 39.803393292153615, -84.18935621080198 39.803193067451105, -84.18943533081894 39.80293032111807, -84.189498335958 39.80272068647769, -84.18955820418013 39.80252136665475, -84.18959572950449 39.80239281568015, -84.18962629019046 39.80229012876618, -84.18965330342938 39.802195240267835, -84.18968373924952 39.80208742048873, -84.18971255810214 39.801985119597624, -84.18973590172311 39.801893076823305, -84.18976341083207 39.8017849391047, -84.1897879815517 39.80168567163635, -84.18980691534296 39.80159477341147, -84.18982653005719 39.80148864147787, -84.18984553391702 39.801386211328676, -84.18986552322873 39.801271425997214, -84.1898885847787 39.80113884911501, -84.18990093481723 39.801051019265664, -84.18991497548511 39.80095100261383, -84.18992799027694 39.800837578916834, -84.18994150093883 39.80072054483935, -84.1899490342108 39.8006411619461, -84.18995913396954 39.8005327344639, -84.18996592163982 39.80041300480578, -84.18997293299061 39.800288046992996, -84.18997664393106 39.800190702217, -84.18998093069159 39.80007857545699, -84.18998207334863 39.79996685432896, -84.1899760052289 39.79958201179507, -84.18996605638712 39.79940306764464, -84.18995294278061 39.79921398997215, -84.18994702467951 39.799143359449396, -84.18994169766987 39.79907785474753, -84.18993417966927 39.799013463228654, -84.18992708567346 39.79895212772834, -84.18991139839366 39.79883506490565, -84.18989604708376 39.798731869542415, -84.18989216456511 39.79870661194626, -84.18987415334367 39.79859003251833, -84.18986305914989 39.79851785467099, -84.18984635857046 39.79842639045502, -84.18982507658305 39.79830976776105, -84.18979923654392 39.79818339263988, -84.18977538806975 39.798066897217176, -84.18974900634649 39.79795665464037, -84.18972164635788 39.79785426340189, -84.18969405190897 39.79774701104913, -84.18967074062736 39.7976574431248, -84.1896379826622 39.79755395887735, -84.18960737346721 39.79745719965037, -84.18956929478063 39.797336586028884, -84.18953689075171 39.797238050640985, -84.18950720412651 39.79714560258331, -84.18947698120708 39.79706478272839, -84.1894396948346 39.79696235427214, -84.18941257469618 39.79688905660542, -84.18938297969912 39.79681002957008, -84.18934365504926 39.79671501755736, -84.18929949027664 39.796608274172186, -84.18924895105874 39.79649387565775, -84.18918569349307 39.7963510145964, -84.18914056842141 39.796257617704065, -84.18908216085994 39.796136576125676, -84.18901208238631 39.79600137969446, -84.18895413206734 39.795889520804494, -84.18888807714787 39.795770931560796, -84.18882905154547 39.79566773574105, -84.18877100241183 39.79556623767159, -84.18869829097609 39.79544279019686, -84.18863164496517 39.79533835289146, -84.18856403326531 39.79523257849329, -84.18850164077726 39.7951349263202, -84.18844241754552 39.79504758782521, -84.18836526843229 39.79493375337864, -84.18831902495809 39.79486640663181, -84.18825268796762 39.79476980168266, -84.18817131138265 39.79465981127082, -84.18815813758901 39.794642987982435, -84.18811202077727 39.794584094706956, -84.18805562274711 39.79451212041048, -84.18800170047386 39.79444110060824, -84.18794735150087 39.794371708265146, -84.18788553034132 39.79429278532109, -84.18780763472809 39.79419625687084, -84.18768566327545 39.79404946644316, -84.18757776752499 39.79391967931961, -84.18743006023776 39.793742090530145, -84.18729883074779 39.79358426312311, -84.18717313398166 39.79343302149779, -84.18705032170591 39.79328516165828, -84.18692895931103 39.79313926244346, -84.18683922569899 39.7930311930974, -84.18673433211819 39.79290469507886, -84.18658036447177 39.792719177713515, -84.18642410971462 39.79253081124475, -84.18627494536 39.792355493892465, -84.18616688701448 39.79222840999907, -84.186089600459 39.79213754759092, -84.18598016409784 39.792005100812254, -84.1859572696345 39.79197739176951, -84.1858348068034 39.79182925546481, -84.18567264382662 39.79163304468846, -84.18555583229696 39.791491583013695, -84.18540798577088 39.79131264266205, -84.1852523239018 39.79112435517166, -84.1851018318372 39.790942209716285, -84.18493750931049 39.79074341693166, -84.1847663299432 39.79053625491171, -84.18469249651169 39.79044317937608, -84.18462366579799 39.79035417554441, -84.18456005339777 39.7902684296177, -84.184437209681 39.79008984916121, -84.18435779501661 39.789968747030116, -84.18427532428365 39.78982264612697, -84.18421710985997 39.78971385093464, -84.18415066686829 39.78957382520697, -84.18409371547591 39.78943510379867, -84.18405408000895 39.78932198760627, -84.18401607049263 39.7892036231116, -84.18398684200824 39.78910071632592, -84.18395915413457 39.78899391418565, -84.18393638992694 39.78888307792782, -84.18391673928011 39.788765800549086, -84.18390010068441 39.78863298488428, -84.18388551563746 39.78841546304386, -84.18388183973131 39.788360652260735, -84.18388465145814 39.78825476221025, -84.18389130887272 39.78812926873921, -84.18389789532038 39.78806359271216, -84.18390802382521 39.78798020883472, -84.18392264749973 39.787894417841876, -84.1839392205184 39.78780229339361, -84.18395497427355 39.787714955252234, -84.18397726956057 39.787618063455106, -84.18399545325856 39.787539428204624, -84.1840200293681 39.787445116452425, -84.18404609039281 39.787359071456734, -84.18407263740609 39.787273829849255, -84.18410394459205 39.78717293513224, -84.18414519433158 39.787048655289965, -84.1841860074899 39.78692564328963, -84.18422606965662 39.78680534392186, -84.18426461007725 39.78668975146141, -84.1842926842265 39.786609712470046, -84.18432341469406 39.78653332919314, -84.18440999701609 39.786323266978464, -84.1844536192063 39.78619571013102, -84.18452471816609 39.78598280767566, -84.18459745385631 39.78576997221115, -84.18465241009045 39.78560414589441, -84.18470268610196 39.78545244078579, -84.18474975782286 39.7853082583225, -84.18480553421884 39.78513773540473, -84.18486173731459 39.78496558568999, -84.18490819638446 39.78482024109976, -84.18493754164983 39.784715590236694, -84.18496819935386 39.784602453168546, -84.1849938094243 39.784497856509276, -84.18502061515237 39.7843847749988, -84.1850414003714 39.7842931297644, -84.18506640587567 39.784182866492266, -84.18509139610855 39.784062333832644, -84.18511125426622 39.783961332928804, -84.18513125705266 39.78384699829086, -84.18514845619708 39.78373261306925, -84.18516328828075 39.783626550217775, -84.18517702980964 39.78351888150406, -84.18519048747092 39.783404279664566, -84.18522027111416 39.78314404715885, -84.18523754122549 39.78299382912279, -84.1852535510005 39.78285457600705, -84.18529431744639 39.78249815484133, -84.18532556354691 39.782226009178274, -84.18536488460353 39.781862942278465, -84.18540438622153 39.7814977106075, -84.1854362341933 39.781202224419005, -84.1854638232523 39.78094787781106, -84.18548252168493 39.78070248830317, -84.18549500197918 39.78053790415071, -84.18550520863745 39.780404791627234, -84.18551646452795 39.7802813038278, -84.18552748416154 39.780172142154406, -84.18555494476146 39.77991734783627, -84.18559387055936 39.779557348478335, -84.18562400813883 39.77927810247894, -84.18565900201071 39.77895347306708, -84.18569319368706 39.77863912526271, -84.18572700088447 39.77832820582187, -84.18575909409631 39.77803334669779, -84.1857896628671 39.77775265230223, -84.18581619550733 39.77751264470007, -84.18584227000676 39.77727786802753, -84.18587137811693 39.77701404095861, -84.18589792333356 39.776774573430245, -84.18592541896778 39.77652617341157, -84.18594899076085 39.77631341363738, -84.1859673846646 39.77614721242708, -84.18598129238183 39.776032063940306, -84.18599149454852 39.775947056845304, -84.18600124486261 39.77587719087224, -84.18600967016165 39.775815271372814, -84.18601609221761 39.77576707359802, -84.18603132674652 39.77566812068727, -84.18604710116291 39.77558186212739, -84.18606154517438 39.77550814538628, -84.18608210401797 39.77541695297423, -84.18610076472136 39.77533416685347, -84.18612079355893 39.77525964828218, -84.1861398755722 39.775189467474874, -84.18615855873348 39.77513172364908, -84.18617648192003 39.77507633338567, -84.18619937368842 39.77501402515452, -84.18621953368 39.774959413581215, -84.1862448697643 39.77489680008179, -84.18626437129078 39.774848773576736, -84.18628917197915 39.77478814974927, -84.18631549890519 39.77472786348106, -84.18633940846478 39.77467382817718, -84.18636526916518 39.77461841407111, -84.18639344841733 39.77456233504977, -84.18642163036444 39.77450634642738, -84.18645229705159 39.77445176344877, -84.18647971992227 39.77440299305336, -84.1865253830848 39.774326482997644, -84.18656553867632 39.77426356582849, -84.18660434320165 39.77420273919266, -84.1866455120928 39.774138276059354, -84.18667543677154 39.77409163124745, -84.18670929337628 39.77404339774459, -84.18674348415433 39.77399452971035, -84.18678301362009 39.7739395479522, -84.1868149172874 39.773897469461666, -84.18685566846194 39.77384472252612, -84.18690080611002 39.77378993051489, -84.18693490166663 39.77375208699493, -84.18697243148257 39.77371043438178, -84.18704428233227 39.77363066405798, -84.18711045133776 39.773557281464655, -84.18718436471934 39.77348072490072, -84.18724332025313 39.77342285053144, -84.18729646278871 39.773370826110316, -84.1873536558279 39.77331730134868, -84.18744589753622 39.77323632991263)",

# CSV_FILENAME = "D7_July2025_OHGO_SB_ALL.csv"
# linestring_or_polygon_wkt = D7_linestring_or_polygon_wkt

CSV_FILENAME = "D4_July2025_OHGO_SB_ALL.csv"
linestring_or_polygon_wkt = D4_linestring_or_polygon_wkt

metadata_id = insert_metadata(
    conn,
    district=4,
    downloaded_at=datetime.now(),
    source="LS from OHGO",
    filename=CSV_FILENAME,
    route_linestring=linestring_or_polygon_wkt  # whatever string format you already have
)
    

import_csv(conn,CSV_FILENAME,metadata_id=metadata_id)

res = verify_csv_uploaded(conn, CSV_FILENAME, table_name="vehicle_telemetry")
print(res)



CSV_FILENAME = "D7_July2025_OHGO_SB_ALL.csv"
linestring_or_polygon_wkt = D7_linestring_or_polygon_wkt

metadata_id = insert_metadata(
    conn,
    district=7,
    downloaded_at=datetime.now(),
    source="LS from OHGO",
    filename=CSV_FILENAME,
    route_linestring=linestring_or_polygon_wkt  # whatever string format you already have
)
    

import_csv(conn,CSV_FILENAME,metadata_id=metadata_id)

res = verify_csv_uploaded(conn, CSV_FILENAME, table_name="vehicle_telemetry")
print(res)